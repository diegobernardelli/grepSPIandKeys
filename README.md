<h1>grepSPIandKeys</h1>

2023-11 | Authors: Stephane Frati and Diego Bernardelli @Fortinet

 PURPOSE:
 extract IPSec Security Parameter Index and keys out of "vpn tunnel list" output to generate lines
 to be added in Wireshark 4.0.4+ configuration file 
 See related article: Technical Tip: Decrypt ESP packets 
 https://community.fortinet.com/t5/FortiGate/Technical-Tip-Decrypt-ESP-packets/ta-p/198431
 On Wireshark, open the PCAP file.
 Edit the protocol preferences as follows:
 1) Go to Edit -> Preferences -> Protocol -> ESP
 2) In front of ESP SAs, click on Edit...
 3) Click on the configuration filename at bottom right of the opened window and paste here 
    the output generated by this script
 4) Restart Wireshark (and check new decryption material was added to ESP protocol)

 A-IN A FIRST SSH SESSION, CAPTURE IPSEC TRAFFIC USING CLI #diag snif pack ... <br>

 B-CLI TO RUN PERIODICALLY IN A SECOND SSH SESSION WHILE SNIFFING IPSEC TRAFFIC ON THE OTHER ONE
 
baryon-tam-kvm23 # diagnose vpn tunnel list
list all ipsec tunnel in vd 0
#------------------------------------------------------
name=kvm14-kvm23 ver=1 serial=1 10.5.26.146:0->10.5.26.122:0 dst_mtu=1500
bound_if=4 lgwy=static/1 tun=intf/0 mode=auto/1 encap=none/512 options[0200]=frag-rfc  run_state=0 role=primary accept_traffic=1 overlay_id=0

proxyid_num=1 child_num=0 refcnt=12 ilast=1732 olast=1732 ad=/0
stat: rxp=5 txp=5 rxb=420 txb=420
dpd: mode=on-demand on=1 idle=20000ms retry=3 count=0 seqno=0
natt: mode=none draft=0 interval=0 remote_port=0
proxyid=kvm14-kvm23 proto=0 sa=1 ref=2 serial=5
  src: 0:10.85.0.0/255.255.240.0:0
  dst: 0:10.63.0.0/255.255.240.0:0
  SA:  ref=3 options=30202 type=00 soft=0 mtu=1438 expire=42926/0B replaywin=2048
       seqno=1 esn=0 replaywin_lastseq=00000000 qat=0 rekey=0 hash_search_len=1
  life: type=01 bytes=0/0 timeout=42927/43200
  dec: spi=**daf3281b** esp=**aes** key=16 **3594b1af384aa2f4c45486b7bb2baaa9**
       ah=**sha256** key=32 **84621e67a8e0d1b830a451fe37c2329fab05889383ebd5c8b33dc314c2d119c4**
  enc: spi=**758f7b3e** esp=aes key=16 **009bfcf4948499f70ba5d6f6d94b00c2**
       ah=sha256 key=32 **80805efd35bfd48e3a0c236595fbb95bf8d18106c657e441b209a2b871f022af**
  dec:pkts/bytes=0/0, enc:pkts/bytes=0/0
run_tally=1

 -----------------------------------------------------------------------------------------------------------------
 to TRANSLATE INTO that kind of triplet (spi, key1, key2) to insert at the end of Wireshark ESP SA's config file <br>
 Note: currenty supporting AES-CBC, AES-GCM, des and 3des

RUN Example

$ ./grepSPIandKeys.py clilog.log
![runSample](https://github.com/diegobernardelli/grepSPIandKeys/assets/152480651/2adff1a3-4bdb-4239-bc10-2684513423e2)

Copy the output at this location: C:\Users\<user>\AppData\Roaming\Wireshark\profiles\General\esp_sa<br>
Finally check on wireshark the loaded SAs

![wsESP_SAs](https://github.com/diegobernardelli/grepSPIandKeys/assets/152480651/f6f8a11a-e714-4ad5-be9a-bc62d96d93b0)

